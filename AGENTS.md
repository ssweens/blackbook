# Repository Guidelines

## Project Structure & Module Organization

- `tui/`: Plugin manager TUI (Ink/React) for installing plugins from marketplaces
  - `src/`: Source code
    - `components/`: UI components (PluginList, PluginDetail, ToolsList, etc.)
    - `lib/`: Core logic (config, marketplace, install, store, types)
    - `cli.tsx`: Entry point for the TUI
    - `App.tsx`: Main app component
  - `dist/`: Build output (generated by `pnpm build`)
  - `package.json`: Project dependencies and scripts
- `docs/`: Documentation (test coverage, etc.)
- `assets/`: UI screenshots for README
- `.nvmrc`: Node.js version specification
- `CHANGELOG.md`: Version history
- `CONTRIBUTING.md`: Contribution guidelines
- `LICENSE`: Apache 2.0 license
- `README.md`: User-facing documentation
- `RELEASING.md`: Release process documentation
- `.github/workflows/`: CI/CD configuration

## Build, Test, and Development Commands

```bash
# Development
cd tui
pnpm install              # Install dependencies
pnpm dev                  # Run in development mode (hot reload)
pnpm build                # Build for production
pnpm start                # Run built application
pnpm typecheck            # Type check with TypeScript
pnpm test                 # Run tests
pnpm test:watch           # Run tests in watch mode
```

**Installation from npm:**
```bash
npm install -g @ssweens/blackbook
blackbook
```

**Run from source:**
```bash
cd tui
pnpm install
pnpm build
pnpm start
```

## Coding Style & Naming Conventions

### TypeScript/React
- Use TypeScript with strict type checking
- Components use PascalCase (e.g., `PluginList`, `PluginDetail`)
- Helper functions use camelCase (e.g., `getInstallStatus`, `buildSyncPreview`)
- Constants use UPPER_SNAKE_CASE (e.g., `LOCK_RETRY_COUNT`, `LOCK_STALE_MS`)
- Interfaces use PascalCase (e.g., `Plugin`, `ToolInstance`, `AppState`)
- Type aliases use PascalCase (e.g., `SyncPreviewItem`, `Notification`)

### File Structure
- Components: `components/ComponentName.tsx`
- Lib modules: `lib/moduleName.ts` or `lib/moduleName.tsx`
- Tests: `lib/moduleName.test.ts` or `lib/moduleName.test.tsx`
- E2E tests: `app.e2e.test.tsx`

### Git
- Conventional commits: `feat:`, `fix:`, `docs:`, `chore:`, `test:`, `refactor:`, `perf:`
- PRs should include:
  - Clear summary of changes
  - List of affected files/modules
  - Test coverage status
  - Link to issue (if applicable)

## Testing Guidelines

### Test Files
- Unit tests: `*.test.ts` in `lib/`
- Integration tests: `*.integration.test.ts` in `lib/`
- E2E tests: `*.e2e.test.tsx` in `src/`
- Validation tests: `*.test.ts` for validation functions

### Running Tests
```bash
pnpm test              # Run all tests once
pnpm test:watch        # Run tests in watch mode
```

### Test Coverage Areas
- Critical paths: Plugin discovery, install/update/uninstall flows, sync previews
- Boundaries: Marketplace fetching, tool config loading, plugin adapters
- User journeys: Install to all tools, asset syncing, marketplace management
- Error cases: Network failures, invalid inputs, permission errors

### Test Best Practices
1. **Write tests before implementation** for new features
2. **Test both success and failure paths**
3. **Mock external dependencies** (network, file system, Git)
4. **Keep tests independent** - no shared state between tests
5. **Use descriptive test names** that explain what's being tested
6. **Test edge cases** - empty lists, null values, invalid inputs
7. **Update test coverage** when adding new features

### Test Coverage Checklist
Critical paths:
- [ ] Plugin discovery list loads
- [ ] Plugin detail view shows actions and tool status
- [ ] Plugin install/update/uninstall flow
- [ ] Sync preview generation
- [ ] Discover → plugin detail → install to all tools (E2E)
- [ ] Install failure notification stays on detail (E2E)

Boundaries:
- [ ] Marketplace fetch (remote marketplace.json)
- [ ] Tool config loading and updates
- [ ] Plugin install/uninstall/update adapters
- [ ] Asset sync adapters (hashing + drift detection)

User journeys (happy paths):
- [ ] Discover → open plugin → install to all tools
- [ ] Installed → open plugin → uninstall
- [ ] Sync → select items → sync
- [ ] Marketplaces → add marketplace
- [ ] Tools → toggle enabled
- [ ] Search + sort

User journeys (problem paths):
- [ ] Install failure surfaces error notification
- [ ] Sync with no drift/missing shows success message
- [ ] Marketplace fetch failure shows error
- [ ] Invalid marketplace URL rejected
- [ ] Asset source missing shows error status

## Commit & Pull Request Guidelines

### Conventional Commits
Use conventional commit prefixes:
- `feat:` New feature
- `fix:` Bug fix
- `docs:` Documentation changes
- `test:` Test additions or modifications
- `chore:` Maintenance tasks (builds, deps, config)
- `refactor:` Code restructuring without behavior change
- `perf:` Performance improvements

### Pre-commit Checklist
Before committing, verify:

1. **Tests pass**: `cd tui && pnpm test` - all tests must pass
2. **Type check passes**: `cd tui && pnpm typecheck` - no type errors
3. **Build succeeds**: `cd tui && pnpm build`

**For `feat:` and `fix:` commits (REQUIRED):**
4. **Version bump**: Update `tui/package.json` version
   - `feat:` → minor version bump (0.X.0)
   - `fix:` → patch version bump (0.0.X)
5. **Changelog updated**: Update `CHANGELOG.md`
   - Add entry under `[Unreleased]` with date
   - Categorize under `### Added`, `### Changed`, `### Fixed`, `### Removed`

**Optional for other commit types** (`refactor:`, `perf:`, `test:`, `docs:`, `chore:`):
- Version bump only if releasing
- Changelog entry only if user-facing change

6. **Documentation updated**: Check if changes require documentation updates
   - New features → usage instructions
   - New keyboard shortcuts → Navigation section in README
   - Config changes → Example Configuration in README
   - New tabs/UI elements → Screenshots

### PR Submission
- Include a clear summary of changes
- List affected modules/files
- Mention test coverage status
- Link to any related issues
- Ensure CI passes (check GitHub Actions workflow)

### Release Checklist
For version releases, complete these steps in order:

1. **Quality gates pass**
   - `cd tui && pnpm test` - all tests pass
   - `cd tui && pnpm typecheck` - no type errors
   - `cd tui && pnpm build` - build succeeds

2. **Update CHANGELOG.md**
   - Add new version section below `[Unreleased]` with date (YYYY-MM-DD)
   - Categorize changes under `### Added`, `### Changed`, `### Fixed`, `### Removed`
   - Update links at bottom: add new version link, update `[Unreleased]` compare URL

3. **Bump version** in `tui/package.json`
   - `feat:` → minor version bump
   - `fix:` → patch version bump

4. **Update documentation**
   - README.md: Document new features in appropriate sections
   - New UI elements → Update screenshots

5. **Update screenshots**: `./scripts/capture-screenshots.sh`

6. **Commit changes**
   ```bash
   git add -A
   git commit -m "feat: description of changes

   v0.X.Y"
   ```

7. **Create git tag and push**
   ```bash
   git tag v0.X.Y
   git push && git push --tags
   ```

8. **Publish to npm** (manual)
   ```bash
   cd tui && npm publish
   ```

## Configuration

### Configuration File Location
```bash
~/.config/blackbook/config.toml
```

Or use custom location via `XDG_CONFIG_HOME` environment variable.

### Example Configuration
```toml
[marketplaces]
playbook = "https://raw.githubusercontent.com/ssweens/playbook/main/.claude-plugin/marketplace.json"

[tools.claude-code]
[[tools.claude-code.instances]]
id = "claude-main"
name = "Claude"
enabled = true
config_dir = "~/.claude"

[tools.opencode]
[[tools.opencode.instances]]
id = "opencode"
name = "OpenCode"
enabled = true
config_dir = "~/.config/opencode"
```

### Supported Tools
- **Claude Code**: `~/.claude` (skills, commands, agents)
- **OpenAI Codex**: `~/.codex` (skills)
- **OpenCode**: `~/.config/opencode` (skills, commands, agents)
- **Amp Code**: `~/.config/amp` (skills, commands, agents)
- **Pi**: `~/.pi` (config sync only)

### Private Repositories
For private GitHub repos, set a token in your environment:
```bash
export GITHUB_TOKEN=ghp_xxxxxxxxxxxx
# or
export GH_TOKEN=ghp_xxxxxxxxxxxx
```

### Cache Location
```bash
~/.cache/blackbook/
├── plugins/      # Downloaded plugin sources
├── http_cache/   # Cached marketplace data
└── assets/       # Cached asset URL sources
```

## Development Workflow

### Local Development
1. Clone the repository
2. `cd tui && pnpm install`
3. Make your changes
4. Test locally: `pnpm dev`
5. Run tests: `pnpm test`
6. Type check: `pnpm typecheck`
7. Build: `pnpm build`
8. Commit changes (follow PR guidelines)

### Debugging
- Use `pnpm dev` for hot-reload development
- Inspect error messages in the TUI (shown on notifications)
- Check logs in `~/.cache/blackbook/` for troubleshooting
- Use test watch mode to debug failing tests: `pnpm test:watch`

## Release Process

See `RELEASING.md` for detailed release instructions:
1. Update version in `tui/package.json`
2. Update `CHANGELOG.md`
3. Create git tag
4. Push tags: `git push --tags`
5. CI will build and publish to npm

## Security Notes

- **Never commit secrets** to the repository
- **GitHub tokens** should only be used for private repositories
- **Config files** may contain sensitive tool credentials
- **Use environment variables** for sensitive values
- **Validate all user inputs** before processing
- **Sanitize marketplace URLs** to prevent code execution

## Performance Considerations

- **Marketplace fetches** are cached to avoid redundant requests
- **Plugin installations** use atomic file operations with locks
- **Sync previews** are computed on-demand and cached
- **Large plugins** may take time to install - show progress
- **Network operations** should use timeouts and retry logic

## Common Issues & Troubleshooting

### Installation Fails
- Check `~/.config/blackbook/config.toml` for syntax errors
- Verify Git is installed and accessible
- Check disk space and permissions
- Review error notifications in the TUI

### Lock Conflicts
- Stop other instances of Blackbook running concurrently
- Check `~/.cache/blackbook/*.lock` files
- Remove stale locks if needed: `rm ~/.cache/blackbook/*.lock`

### Plugin Installation Issues
- Verify marketplace URL is accessible
- Check GitHub token for private repos
- Review plugin manifest format
- Check tool config directory permissions

### Cache Corruption
- Clear cache: `rm -rf ~/.cache/blackbook/*`
- Reinstall plugins from scratch
- Force marketplace update

## Contributing

See `CONTRIBUTING.md` for more detailed contribution guidelines.

### Getting Started as a Contributor
1. Fork the repository
2. Create a feature branch: `git checkout -b feat/your-feature`
3. Make your changes
4. Write tests
5. Verify tests pass
6. Submit a pull request

### Code Review Process
- PRs are reviewed by maintainers
- Ensure all CI checks pass
- Address review feedback
- Update documentation as needed

## External Dependencies

- **Node.js**: 23.x (required for development and runtime)
- **pnpm**: Package manager
- **Ink**: React-based TUI framework
- **Zustand**: State management
- **Vitest**: Testing framework
- **TypeScript**: Type checking
- **Git**: Plugin source control

## License

Apache 2.0 - see `LICENSE` file for details.
